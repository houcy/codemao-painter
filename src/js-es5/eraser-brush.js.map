{"version":3,"sources":["../js/eraser-brush.js"],"names":[],"mappings":"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","file":"eraser-brush.js","sourcesContent":["/**\n * Created by GreenDou on 16/4/9.\n * Eraser Brush\n */\n\n(() => {\n  /**\n   * EraserBrush class\n   * @class fabric.EraserBrush\n   * @extends fabric.BaseBrush\n   */\n  fabric.EraserBrush = fabric.util.createClass(\n    fabric.BaseBrush, /** @lends fabric.PencilBrush.prototype */ {\n\n      /**\n       * Constructor\n       * @param {fabric.Canvas} canvas\n       * @param options\n       * @return {fabric.PencilBrush} Instance of a pencil brush\n       */\n      initialize: function (canvas, options) {\n        this.canvas = canvas;\n        this.backupCanvasEl = this.canvas._createCanvasElement();\n        this.backupContext = this.backupCanvasEl.getContext('2d');\n        this.canvas._copyCanvasStyle(this.canvas.upperCanvasEl, this.backupCanvasEl);\n        this.canvas._applyCanvasStyle(this.backupCanvasEl);\n        this.backupContext.imageSmoothingEnabled = false;\n        this.canvas.freeDrawingCursor = 'none';\n        this._points = [];\n        this.strokeStyle = 'rgb(255,255,255)';\n        this.width = 10;\n        //  init options\n\n        //  Dynamic events\n        //  this.onMouseOut = this.onMouseOut.bind(this);\n        //  this.events = {\n        //    mouseout: this.canvas._onMouseOut\n        //  };\n\n        for (let prop in options) {\n          if (options.hasOwnProperty(prop)) {\n            this[prop] = options[prop];\n          }\n        }\n\n        this.cursorRenderer = new fabric.CursorRenderer(this.canvas.cursorCanvasEl, this);\n      },\n\n      /**\n       * Inovoked on mouse down\n       * @param {Object} pointer\n       */\n      onMouseDown: function (pointer) {\n        this._prepareForDrawing(pointer);\n        // capture coordinates immediately\n        // this allows to draw dots (when movement never occurs)\n        this._captureDrawingPath(pointer);\n        this._render();\n      },\n\n      /**\n       * Inovoked on mouse move\n       * @param {Object} pointer\n       */\n      onMouseMove: function (pointer) {\n        this._captureDrawingPath(pointer);\n        // redraw curve\n        // clear top canvas\n        this.canvas.clearContext(this.canvas.contextTop);\n        this._render();\n      },\n\n      /**\n       * Invoked on mouse up\n       */\n      onMouseUp: function () {\n        this._finalizeAndAddPath();\n      },\n\n      onMouseOut: function (options) {\n        this.canvas.clearContext(this.canvas.contextCursor);\n      },\n\n      /**\n       * @private\n       * @param {Object} pointer Actual mouse position related to the canvas.\n       */\n      _prepareForDrawing: function (pointer) {\n\n        let p = new fabric.Point(pointer.x, pointer.y);\n\n        this._reset();\n        this._addPoint(p);\n\n        this.canvas.clearContext(this.backupCanvasEl.getContext('2d'));\n        this.backupContext.drawImage(this.canvas.lowerCanvasEl, 0, 0, this.backupCanvasEl.width, this.backupCanvasEl.height);\n        this.canvas.clearContext(this.canvas.contextContainer);\n        this.canvas.contextTop.moveTo(p.x, p.y);\n\n        this.cursorRenderer.prepareForRender();\n      },\n\n      /**\n       * @private\n       * @param {fabric.Point} point Point to be added to points array\n       */\n      _addPoint: function (point) {\n        this._points.push(point);\n      },\n\n      /**\n       * Clear points array and set contextTop canvas style.\n       * @private\n       */\n      _reset: function () {\n        this._points.length = 0;\n\n        this._setBrushStyles();\n        this._setShadow();\n      },\n\n      _setBrushStyles: function () {\n        \"use strict\";\n        let ctx = this.canvas.contextTop;\n        ctx.strokeStyle = this.strokeStyle;\n        ctx.lineWidth = this.width;\n        ctx.lineCap = this.strokeLineCap;\n        ctx.lineJoin = this.strokeLineJoin;\n        if (this.strokeDashArray && fabric.StaticCanvas.supports(\"setLineDash\")) {\n          ctx.setLineDash(this.strokeDashArray);\n        }\n      },\n\n      /**\n       * @private\n       * @param {Object} pointer Actual mouse position related to the canvas.\n       */\n      _captureDrawingPath: function (pointer) {\n        let pointerPoint = new fabric.Point(pointer.x, pointer.y);\n        this._addPoint(pointerPoint);\n      },\n\n      /**\n       * Draw a smooth path on the topCanvas using quadraticCurveTo\n       * @private\n       */\n      _render: function () {\n        let ctx = this.canvas.contextTop,\n          v = this.canvas.viewportTransform,\n          p1 = this._points[0],\n          p2 = this._points[1];\n\n        ctx.save();\n        ctx.drawImage(this.backupCanvasEl, 0, 0);\n        ctx.globalCompositeOperation = 'destination-out';\n        ctx.transform(v[0], v[1], v[2], v[3], v[4], v[5]);\n        ctx.beginPath();\n\n        //if we only have 2 points in the path and they are the same\n        //it means that the user only clicked the canvas without moving the mouse\n        //then we should be drawing a dot. A path isn't drawn between two identical dots\n        //that's why we set them apart a bit\n        if (this._points.length === 2 && p1.x === p2.x && p1.y === p2.y) {\n          p1.x -= 0.5;\n          p2.x += 0.5;\n        }\n        ctx.moveTo(p1.x, p1.y);\n\n        for (let i = 1, len = this._points.length; i < len; i++) {\n          // we pick the point between pi + 1 & pi + 2 as the\n          // end point and p1 as our control point.\n          let midPoint = p1.midPointFrom(p2);\n          ctx.quadraticCurveTo(p1.x, p1.y, midPoint.x, midPoint.y);\n\n          p1 = this._points[i];\n          p2 = this._points[i + 1];\n        }\n        // Draw last line as a straight line while\n        // we wait for the next point to be able to calculate\n        // the bezier control point\n        ctx.lineTo(p1.x, p1.y);\n        ctx.stroke();\n        ctx.restore();\n      },\n\n      /**\n       * Converts points to SVG path\n       * @param {Array} points Array of points\n       * @param {Number} minX\n       * @param {Number} minY\n       * @return {String} SVG path\n       */\n      convertPointsToSVGPath: function (points) {\n        let path = [],\n          p1 = new fabric.Point(points[0].x, points[0].y),\n          p2 = new fabric.Point(points[1].x, points[1].y);\n\n        path.push('M ', points[0].x, ' ', points[0].y, ' ');\n        for (let i = 1, len = points.length; i < len; i++) {\n          let midPoint = p1.midPointFrom(p2);\n          // p1 is our bezier control point\n          // midpoint is our endpoint\n          // start point is p(i-1) value.\n          path.push('Q ', p1.x, ' ', p1.y, ' ', midPoint.x, ' ', midPoint.y, ' ');\n          p1 = new fabric.Point(points[i].x, points[i].y);\n          if ((i + 1) < points.length) {\n            p2 = new fabric.Point(points[i + 1].x, points[i + 1].y);\n          }\n        }\n        path.push('L ', p1.x, ' ', p1.y, ' ');\n        return path;\n      },\n\n      /**\n       * Creates fabric.Path object to add on canvas\n       * @param {String} pathData Path data\n       * @return {fabric.Path} Path to add on canvas\n       */\n      createPath: function (pathData) {\n        let path = new fabric.Path(pathData, {\n          fill: null,\n          stroke: this.color,\n          strokeWidth: this.width,\n          strokeLineCap: this.strokeLineCap,\n          strokeLineJoin: this.strokeLineJoin,\n          strokeDashArray: this.strokeDashArray,\n          originX: 'center',\n          originY: 'center'\n        });\n\n        if (this.shadow) {\n          this.shadow.affectStroke = true;\n          path.setShadow(this.shadow);\n        }\n\n        return path;\n      },\n\n      /**\n       * On mouseup after drawing the path on contextTop canvas\n       * we use the points captured to create an new fabric path object\n       * and add it to the fabric canvas.\n       */\n      _finalizeAndAddPath: function () {\n        let ctx = this.canvas.contextTop,\n          data, trimData, layerObject,\n          myself = this,\n          currentLayer = this.canvas.layerManager.currentLayer;\n        ctx.closePath();\n        trimData = trimCanvasWithPosition(this.canvas.upperCanvasEl);\n        data = trimData.canvas.toDataURL('png');\n\n        fabric.Image.fromURL(data, function (image) {\n          image.set({\n              left: trimData.left,\n              top: trimData.top,\n              angle: 0\n            })\n            .scale(1)\n            .setCoords();\n          Painter.canvas.setHeight(Painter.height);\n          Painter.canvas.setWidth(Painter.width);\n          Painter.canvas.renderAll();\n          Painter.canvas.add(image);\n          myself.canvas.contextTop.imageSmoothingEnabled = false;\n          myself.canvas.clearContext(myself.canvas.contextTop);\n          currentLayer.objects.splice(0, currentLayer.objects.length, image);\n          myself.canvas.renderAll();\n          myself.canvas.contextTop.imageSmoothingEnabled = true;\n        });\n\n      },\n\n      cursorRender: function (pointer) {\n        this.canvas.clearContext(this.canvas.contextCursor);\n        this.cursorRenderer.renderCircle(pointer.x, pointer.y);\n      }\n    });\n})();\n"]}